{{ $context := . }}

{{ $anchor := $context.Anchor }}
{{ $attrs := $context.Attributes }}
{{ $old := $context.Level }}
{{ $page := $context.Page }}
{{ $text := $context.Text }}

{{ $attrs = merge $attrs (dict "id" $anchor) }}

{{ if $page.Param "paige.pages.minimize_heading_sizes" }}
    {{ $cap := $page.Param "paige.pages.maximum_heading_level" }}
    {{ $max := 0 }}
    {{ $new := $old }}
    {{ $store := 0 }}

    {{ with $page.Store.Get "paige-render-heading" }}
        {{ $max = .max }}
    {{ else }}
        {{ range $k, $v := $page.Fragments.HeadingsMap }}
            {{ if gt $v.Level $max }}
                {{ $max = $v.Level }}
            {{ end }}
        {{ end }}

        {{ $page.Store.Set "paige-render-heading" (dict "max" $max) }}
    {{ end }}

    {{ $highest := cond (and $cap (le $max $cap)) $cap 6 }}

    {{ if and $max (lt $max $highest) }}
        {{ $new = add $old (sub $highest $max) }}
    {{ end }}

    {{ if ne $old $new }}
        {{ $class := slice }}
        {{ $found := false }}

        {{ range $k, $v := $attrs }}
            {{ if eq $k "class" }}
                {{ range split $v " " }}
                    {{ if . }}
                        {{ $class = $class | append . }}

                        {{ if in (slice "h1" "h2" "h3" "h4" "h5" "h6") . }}
                            {{ $found = true }}
                        {{ end }}
                    {{ end }}
                {{ end }}

                {{ break }}
            {{ end }}
        {{ end }}

        {{ if not $found }}
            {{ $class = $class | append (print "h" $new) }}
        {{ end }}

        {{ $class = delimit (sort $class) " " }}

        {{ $attrs = merge (dict "class" $class) $attrs }}
    {{ end }}
{{ end }}

<h{{ $old }} {{ range $k, $v := $attrs }} {{ printf `%s="%s"` $k $v | safeHTMLAttr }} {{ end }}>
    <a href="#{{ $anchor }}" style="color: rgba(var(--bs-body-color-rgb), var(--bs-text-opacity)); text-decoration: none">{{ $text }}</a>
</h{{ $old }}>
