{{ $context := . }}

{{ $anchor := $context.Anchor }}
{{ $attrs := $context.Attributes }}
{{ $level := $context.Level }}
{{ $page := $context.Page }}
{{ $text := $context.Text }}

{{ $minimize := $page.Param "paige.pages.minimize_heading_sizes" }}
{{ $normalize := $page.Param "paige.pages.normalize_heading_sizes" }}

{{ $attrs = merge $attrs (dict "id" $anchor) }}

{{ if or $minimize $normalize }}
    {{ $levels := dict }}

    {{ with $page.Store.Get "paige-render-heading" }}
        {{ $levels = .levels }}
    {{ else }}
        {{ $largest := 0 }}
        {{ $max := $page.Param "paige.pages.maximum_heading_level" }}

        {{ range $k, $v := $page.Fragments.HeadingsMap }}
            {{ $levels = merge $levels (dict (string $v.Level) $v.Level) }}

            {{ if gt $v.Level $largest }}
                {{ $largest = $v.Level }}
            {{ end }}
        {{ end }}

        {{ if $normalize }}
            {{ range $x := seq 2 5 }}
                {{ if isset $levels (string $x) | not }}
                    {{ range $y := seq (add $x 1) 6 }}
                        {{ $key := string $y }}

                        {{ if isset $levels $key }}
                            {{ $old := index $levels $key }}
                            {{ $levels = merge $levels (dict $key (sub $old 1)) }}
                        {{ end }}
                    {{ end }}
                {{ end }}
            {{ end }}

            {{ $largest = add (len $levels) 1 }}
        {{ end }}

        {{ if $minimize }}
            {{ $highest := cond (and $max $largest (le $largest $max)) $max 6 }}

            {{ $diff := sub $highest $largest }}

            {{ if and $largest (lt $largest $highest) }}
                {{ range $old, $new := $levels }}
                    {{ $levels = merge $levels (dict $old (add $new $diff)) }}
                {{ end }}
            {{ end }}
        {{ end }}

        {{ $page.Store.Set "paige-render-heading" (dict "levels" $levels) }}
    {{ end }}

    {{ $new := index $levels (string $level) }}

    {{ if ne $level $new }}
        {{ $class := slice }}
        {{ $found := false }}

        {{ range $k, $v := $attrs }}
            {{ if eq $k "class" }}
                {{ range split $v " " }}
                    {{ if . }}
                        {{ $class = $class | append . }}

                        {{ if in (slice "h1" "h2" "h3" "h4" "h5" "h6") . }}
                            {{ $found = true }}
                        {{ end }}
                    {{ end }}
                {{ end }}

                {{ break }}
            {{ end }}
        {{ end }}

        {{ if not $found }}
            {{ $class = $class | append (print "h" $new) }}
        {{ end }}

        {{ $class = delimit (sort $class) " " }}

        {{ $attrs = merge $attrs (dict "class" $class) }}
    {{ end }}
{{ end }}

<h{{ $level }} {{ range $k, $v := $attrs }} {{ printf `%s="%s"` $k $v | safeHTMLAttr }} {{ end }}>
    <a href="#{{ $anchor }}" style="color: rgba(var(--bs-body-color-rgb), var(--bs-text-opacity)); text-decoration: none">{{ $text }}</a>
</h{{ $level }}>
